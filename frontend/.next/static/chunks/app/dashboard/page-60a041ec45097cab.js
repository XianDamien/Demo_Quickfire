(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{6583:function(e,s,t){Promise.resolve().then(t.bind(t,3077))},3077:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return en}});var a=t(7437),r=t(2265),n=t(4280),i=t(5817),l=t(5750),d=t(6141),c=t(3008),o=t(2482),x=t(4949),m=t(6061),u=t(7042),h=t(4769);function p(){for(var e=arguments.length,s=Array(e),t=0;t<e;t++)s[t]=arguments[t];return(0,h.m6)((0,u.W)(s))}function g(e){return({PRONUNCIATION_ERROR:"发音错误",WRONG_MEANING:"意思错误",INCOMPLETE:"回答不完整",ARTICULATION_UNCLEAR:"口齿不清",HESITATION_OR_TIMING:"犹豫或时机问题",SELF_CORRECTION:"自我纠正",INCOMPLETE_AND_EXTRA_WORD:"不完整且有多余词"})[e]||e}function j(e){return({PRONUNCIATION_ERROR:"text-red-700 bg-red-100 border-red-200",WRONG_MEANING:"text-red-800 bg-red-200 border-red-300",INCOMPLETE:"text-yellow-700 bg-yellow-100 border-yellow-200",ARTICULATION_UNCLEAR:"text-orange-700 bg-orange-100 border-orange-200",HESITATION_OR_TIMING:"text-purple-700 bg-purple-100 border-purple-200",SELF_CORRECTION:"text-green-700 bg-green-100 border-green-200",INCOMPLETE_AND_EXTRA_WORD:"text-amber-700 bg-amber-100 border-amber-200"})[e]||"text-gray-700 bg-gray-100 border-gray-200"}function N(e){return["PRONUNCIATION_ERROR","WRONG_MEANING"].includes(e)}function f(e){let s=Math.floor(e/1e3);return"".concat(Math.floor(s/60).toString().padStart(2,"0"),":").concat((s%60).toString().padStart(2,"0"))}let b=(0,m.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),v=r.forwardRef((e,s)=>{let{className:t,variant:r,size:n,asChild:i=!1,...l}=e,d=i?x.g7:"button";return(0,a.jsx)(d,{className:p(b({variant:r,size:n,className:t})),ref:s,...l})});v.displayName="Button";let y=r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("div",{ref:s,className:p("rounded-lg border bg-card text-card-foreground shadow-sm",t),...r})});y.displayName="Card";let _=r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("div",{ref:s,className:p("flex flex-col space-y-1.5 p-6",t),...r})});_.displayName="CardHeader";let w=r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("h3",{ref:s,className:p("text-2xl font-semibold leading-none tracking-tight",t),...r})});w.displayName="CardTitle";let k=r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("p",{ref:s,className:p("text-sm text-muted-foreground",t),...r})});k.displayName="CardDescription";let C=r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("div",{ref:s,className:p("p-6 pt-0",t),...r})});C.displayName="CardContent",r.forwardRef((e,s)=>{let{className:t,...r}=e;return(0,a.jsx)("div",{ref:s,className:p("flex items-center p-6 pt-0",t),...r})}).displayName="CardFooter";var E=t(4660),T=t(4810);let R=(0,E.Ue)()((0,T.mW)((e,s)=>({tasks:[],selectedTaskId:null,selectedReport:null,isLoading:!1,error:null,filterGrade:"ALL",sortBy:"priority",expandedCards:new Set,audioPlayingTaskId:null,setTasks:s=>e({tasks:s}),addTask:s=>e(e=>({tasks:[...e.tasks,s]})),updateTask:(s,t)=>e(e=>({tasks:e.tasks.map(e=>e.task_id===s?{...e,...t}:e)})),setSelectedTaskId:s=>e({selectedTaskId:s}),setSelectedReport:s=>e({selectedReport:s}),setLoading:s=>e({isLoading:s}),setError:s=>e({error:s}),setFilterGrade:s=>e({filterGrade:s}),setSortBy:s=>e({sortBy:s}),toggleCardExpansion:s=>e(e=>{let t=new Set(e.expandedCards);return t.has(s)?t.delete(s):t.add(s),{expandedCards:t}}),setAudioPlaying:s=>e({audioPlayingTaskId:s}),getFilteredAndSortedTasks:()=>{let{tasks:e,filterGrade:t,sortBy:a}=s(),r=e;return"ALL"!==t&&(r=r.filter(e=>{var s;return(null===(s=e.result)||void 0===s?void 0:s.final_grade_suggestion)===t})),[...r].sort((e,s)=>{if("priority"===a){let t=e=>e.result?100*({C:3,B:2,A:1})[e.result.final_grade_suggestion]+e.result.mistake_count:0;return t(s)-t(e)}if("created_at"===a)return new Date(s.created_at).getTime()-new Date(e.created_at).getTime();if("student_name"===a){var t,r;let a=(null===(t=e.result)||void 0===t?void 0:t.student_name)||e.student_id,n=(null===(r=s.result)||void 0===r?void 0:r.student_name)||s.student_id;return a.localeCompare(n,"zh-CN")}return 0})},getTaskById:e=>s().tasks.find(s=>s.task_id===e),getPendingTasksCount:()=>s().tasks.filter(e=>"PENDING"===e.status||"PROCESSING"===e.status).length,getCompletedTasksCount:()=>s().tasks.filter(e=>"COMPLETED"===e.status).length}),{name:"evaluation-store"}));var O=t(9891),I=t(8038),S=t(3588);[{task_id:"t003",student_id:"s003",student_name:"学生C",audio_url:"https://storage.googleapis.com/maker-suite-apps/prompts-api-explore/quick-reply-audio-3.mp3",unit_id:"R200",session_index:1,final_grade_suggestion:"C",mistake_count:2,ai_summary_comment:"整体表现不错，但在'sharp'的发音和'title'的完整性上存在一些小问题，建议针对性练习。",full_transcription:"okay first one avoid avoid is 避免... um... plate is 盘子... sharp... shop... yes... title is an 稱呼...",annotations:[{card_index:3,question:"sharp",expected_answer:"尖锐的",detected_text:"shop",start_time:5200,end_time:6100,issue_type:"PRONUNCIATION_ERROR",explanation:"发音错误：学生将 'sharp' /ʃɑːrp/ 误读为 'shop' /ʃɒp/。"},{card_index:4,question:"title",expected_answer:"题目，称呼",detected_text:"an 稱呼",start_time:8300,end_time:9500,issue_type:"INCOMPLETE_AND_EXTRA_WORD",explanation:"回答不完整且包含额外信息：遗漏了'题目'，并增加了不必要的冠词'an'。"}],status:"COMPLETED",created_at:"2024-01-15T10:30:00Z",updated_at:"2024-01-15T10:35:00Z"},{task_id:"t002",student_id:"s002",student_name:"学生B",audio_url:"https://storage.googleapis.com/maker-suite-apps/prompts-api-explore/quick-reply-audio-2.mp3",unit_id:"R200",session_index:1,final_grade_suggestion:"B",mistake_count:1,ai_summary_comment:"整体表现很好，反应迅速准确。只有'sound'的回答不完整，遗漏了词性部分。稍加注意细节就能达到完美分数。",full_transcription:"声音听起来... 看着看上去... 看样子... 感觉觉得... 触摸联系摸起来... 联系... 吃起来品尝... 味道... 听到听见... 闻起来...",annotations:[{card_index:1,question:"sound",expected_answer:"行为动词, 声音",detected_text:"声音听起来",start_time:1e3,end_time:2500,issue_type:"INCOMPLETE_AND_EXTRA_WORD",explanation:"回答不完整且有多余词汇：遗漏了词性'行为动词'，并添加了'听起来'。"}],status:"COMPLETED",created_at:"2024-01-15T09:20:00Z",updated_at:"2024-01-15T09:25:00Z"},{task_id:"t001",student_id:"s001",student_name:"学生A",audio_url:"https://storage.googleapis.com/maker-suite-apps/prompts-api-explore/quick-reply-audio-1.mp3",unit_id:"R200",session_index:1,final_grade_suggestion:"A",mistake_count:0,ai_summary_comment:"优秀表现！所有回答都迅速、准确、完整。发音清晰自信，贯穿整个练习。",full_transcription:"声音... 看... 样子... 感觉觉得... 触摸联系... 联系... 吃起来品尝... 味道... 听到听见... 闻起来...",annotations:[],status:"COMPLETED",created_at:"2024-01-15T08:10:00Z",updated_at:"2024-01-15T08:15:00Z"}].map(e=>({task_id:e.task_id,student_id:e.student_id,unit_id:e.unit_id,session_index:e.session_index,audio_path:"/uploads/".concat(e.student_id,"_").concat(e.unit_id,"_session").concat(e.session_index,".mp3"),status:e.status,created_at:e.created_at,updated_at:e.updated_at,result:e}));let A=t(2601).env.NEXT_PUBLIC_API_URL||"http://localhost:8000";class L extends Error{constructor(e,s){super(s),this.status=e,this.name="ApiError"}}async function P(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t="".concat(A).concat(e),a=await fetch(t,{headers:{"Content-Type":"application/json",...s.headers},...s});if(!a.ok){let e=await a.json().catch(()=>({}));throw new L(a.status,e.detail||"HTTP ".concat(a.status,": ").concat(a.statusText))}return a.json()}let D={async createEvaluation(e){let s=new FormData;s.append("student_id",e.student_id),s.append("unit_id",e.unit_id),s.append("session_index",e.session_index.toString()),s.append("audio_file",e.audio_file);let t=await fetch("".concat(A,"/evaluate/session"),{method:"POST",body:s});if(!t.ok){let e=await t.json().catch(()=>({}));throw new L(t.status,e.detail||"HTTP ".concat(t.status,": ").concat(t.statusText))}return t.json()},getTaskStatus:async e=>P("/evaluate/task/".concat(e)),getAllTasks:async()=>P("/evaluate/tasks"),getReportDetail:async e=>P("/evaluate/report/".concat(e)),submitTeacherFeedback:async e=>P("/evaluate/feedback",{method:"POST",body:JSON.stringify(e)}),async exportResults(e){let s=await fetch("".concat(A,"/evaluate/export"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_ids:e})});if(!s.ok)throw new L(s.status,"Export failed");return s.blob()},healthCheck:async()=>P("/health")},Z={all:["evaluations"],tasks:()=>[...Z.all,"tasks"],task:e=>[...Z.all,"task",e],report:e=>[...Z.all,"report",e]};function F(){let{setTasks:e,setLoading:s,setError:t}=R(),a=(0,O.a)({queryKey:Z.tasks(),queryFn:D.getAllTasks,refetchInterval:1e4,staleTime:1e4});return(0,r.useEffect)(()=>{s(a.isFetching)},[a.isFetching,s]),(0,r.useEffect)(()=>{a.data&&e(a.data)},[a.data,e]),(0,r.useEffect)(()=>{a.error&&t(a.error.message)},[a.error,t]),a}function M(){let{filterGrade:e,setFilterGrade:s,sortBy:t,setSortBy:r,getFilteredAndSortedTasks:x,getPendingTasksCount:m,getCompletedTasksCount:u}=R(),{refetch:h,isLoading:g}=F(),j=function(){let{setError:e}=R();return(0,S.D)({mutationFn:e=>D.exportResults(e),onSuccess:e=>{let s=window.URL.createObjectURL(e),t=document.createElement("a");t.href=s,t.download="evaluation_results_".concat(new Date().toISOString().slice(0,10),".xlsx"),document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(s),document.body.removeChild(t)},onError:s=>{e("导出失败: ".concat(s.message))}})}(),N=x(),f=m(),b=u(),_=N.length;return(0,a.jsx)("header",{className:"bg-white border-b border-gray-200 shadow-sm",children:(0,a.jsxs)("div",{className:"container mx-auto px-4 py-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"AI助教 - 单词快反看板"}),(0,a.jsx)("p",{className:"text-gray-600 mt-1",children:"智能评测系统，提升批改效率"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)(v,{variant:"outline",size:"sm",onClick:()=>{h()},disabled:g,className:"flex items-center gap-2",children:[(0,a.jsx)(n.Z,{className:p("h-4 w-4",g&&"animate-spin")}),"刷新"]}),(0,a.jsxs)(v,{onClick:()=>{let e=N.filter(e=>"COMPLETED"===e.status).map(e=>e.task_id);if(0===e.length){alert("没有已完成的评测任务可以导出");return}j.mutate(e)},disabled:j.isPending||0===b,className:"flex items-center gap-2",children:[(0,a.jsx)(i.Z,{className:"h-4 w-4"}),j.isPending?"导出中...":"导出结果"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[(0,a.jsx)(y,{children:(0,a.jsx)(C,{className:"p-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-blue-100 rounded-lg",children:(0,a.jsx)(l.Z,{className:"h-5 w-5 text-blue-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"总任务数"}),(0,a.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:_})]})]})})}),(0,a.jsx)(y,{children:(0,a.jsx)(C,{className:"p-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-orange-100 rounded-lg",children:(0,a.jsx)(d.Z,{className:"h-5 w-5 text-orange-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"处理中"}),(0,a.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:f})]})]})})}),(0,a.jsx)(y,{children:(0,a.jsx)(C,{className:"p-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-green-100 rounded-lg",children:(0,a.jsx)(c.Z,{className:"h-5 w-5 text-green-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"已完成"}),(0,a.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:b})]})]})})})]}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4 p-4 bg-gray-50 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(o.Z,{className:"h-4 w-4 text-gray-500"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"筛选:"})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:[{value:"ALL",label:"全部",color:"bg-gray-100 text-gray-700"},{value:"C",label:"C级",color:"bg-red-100 text-red-700"},{value:"B",label:"B级",color:"bg-blue-100 text-blue-700"},{value:"A",label:"A级",color:"bg-green-100 text-green-700"}].map(t=>(0,a.jsx)("button",{onClick:()=>s(t.value),className:p("px-3 py-1 rounded-full text-xs font-medium border transition-colors",e===t.value?t.color+" border-current":"bg-white text-gray-500 border-gray-300 hover:bg-gray-50"),children:t.label},t.value))}),(0,a.jsx)("div",{className:"h-4 w-px bg-gray-300"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"排序:"}),(0,a.jsx)("select",{value:t,onChange:e=>r(e.target.value),className:"text-sm border border-gray-300 rounded px-2 py-1 bg-white",children:[{value:"priority",label:"优先级排序"},{value:"created_at",label:"创建时间"},{value:"student_name",label:"学生姓名"}].map(e=>(0,a.jsx)("option",{value:e.value,children:e.label},e.value))})]})]})]})})}var G=t(1981),U=t(3523),B=t(7158);function q(e){let{size:s="md",className:t}=e;return(0,a.jsx)("div",{className:p("flex items-center justify-center p-4",t),children:(0,a.jsx)("div",{className:p("animate-spin rounded-full border-2 border-gray-300 border-t-blue-500",{sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"}[s])})})}function W(e){var s;let{task:t,isSelected:r,isExpanded:n,onSelect:i,onToggleExpansion:l}=e,o=t.result,x=(null==o?void 0:o.student_name)||"学生".concat(t.student_id);return(0,a.jsx)(y,{className:p("transition-all duration-200 cursor-pointer hover:shadow-md",r&&"ring-2 ring-blue-500 shadow-md","COMPLETED"===t.status&&(null==o?void 0:o.final_grade_suggestion)==="C"&&"border-red-200 bg-red-50"),children:(0,a.jsxs)(C,{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",onClick:i,children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(()=>{if(!o)return null;let e=100*({C:3,B:2,A:1})[o.final_grade_suggestion]+o.mistake_count;return e>=300?(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-red-500"}):e>=200?(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-blue-500"}):(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-green-500"})})(),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 truncate",children:x}),(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(e=>{switch(e){case"PENDING":case"PROCESSING":return(0,a.jsx)(d.Z,{className:"h-4 w-4 text-orange-500 animate-pulse"});case"COMPLETED":return(0,a.jsx)(c.Z,{className:"h-4 w-4 text-green-500"});case"FAILED":return(0,a.jsx)(G.Z,{className:"h-4 w-4 text-red-500"});default:return(0,a.jsx)(d.Z,{className:"h-4 w-4 text-gray-400"})}})(t.status),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:(e=>{switch(e){case"PENDING":return"等待处理";case"PROCESSING":return"处理中...";case"COMPLETED":return"已完成";case"FAILED":return"处理失败";default:return"未知状态"}})(t.status)})]})]})]}),o&&(0,a.jsx)("div",{className:p("px-2 py-1 rounded text-xs font-medium border",(s=o.final_grade_suggestion,"grade-".concat(s))),children:o.final_grade_suggestion})]}),o&&(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-600 mb-3",children:[(0,a.jsxs)("span",{children:["错误数量: ",o.mistake_count]}),(0,a.jsx)("span",{children:new Date(t.updated_at).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),"COMPLETED"===t.status&&o&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(v,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),l()},className:"w-full justify-between p-2 h-auto text-left hover:bg-gray-50",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:n?"收起详情":"展开详情"}),n?(0,a.jsx)(U.Z,{className:"h-4 w-4"}):(0,a.jsx)(B.Z,{className:"h-4 w-4"})]}),n&&(0,a.jsxs)("div",{className:"mt-3 pt-3 border-t border-gray-100 space-y-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700",children:"AI评语:"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 overflow-hidden text-ellipsis",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:o.ai_summary_comment})]}),o.annotations.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700",children:"问题类型:"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:Array.from(new Set(o.annotations.map(e=>e.issue_type))).map(e=>(0,a.jsx)("span",{className:"inline-block px-2 py-1 text-xs rounded bg-gray-100 text-gray-700",children:g(e)},e))})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["单元: ",o.unit_id," | 会话: ",o.session_index]})]})]}),"FAILED"===t.status&&(0,a.jsx)("div",{className:"mt-3 p-2 bg-red-50 border border-red-200 rounded",children:(0,a.jsx)("p",{className:"text-sm text-red-600",children:"处理失败，请重新上传或联系技术支持"})})]})})}function z(){let{selectedTaskId:e,setSelectedTaskId:s,expandedCards:t,toggleCardExpansion:r,getFilteredAndSortedTasks:n}=R(),{isLoading:i,error:l}=F(),d=n();return i?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"学生列表"}),(0,a.jsx)(q,{})]}):l?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"学生列表"}),(0,a.jsx)(y,{children:(0,a.jsxs)(C,{className:"p-6 text-center",children:[(0,a.jsx)(G.Z,{className:"h-8 w-8 text-red-500 mx-auto mb-2"}),(0,a.jsx)("p",{className:"text-red-600",children:l.message})]})})]}):0===d.length?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"学生列表"}),(0,a.jsx)(y,{children:(0,a.jsxs)(C,{className:"p-6 text-center",children:[(0,a.jsx)("p",{className:"text-gray-500",children:"暂无评测任务"}),(0,a.jsx)("p",{className:"text-sm text-gray-400 mt-1",children:"上传学生录音文件以开始评测"})]})})]}):(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900",children:["学生列表 (",d.length,")"]})}),(0,a.jsx)("div",{className:"space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto",children:d.map(n=>(0,a.jsx)(W,{task:n,isSelected:e===n.task_id,isExpanded:t.has(n.task_id),onSelect:()=>s(n.task_id),onToggleExpansion:()=>r(n.task_id)},n.task_id))})]})}var X=t(4149),H=t(3101),K=t(4900),J=t(8119),Q=t(1243),V=t(734),Y=t(6245);function $(e){let{audioUrl:s,onSeek:t}=e,n=(0,r.useRef)(null),[i,l]=(0,r.useState)(!1),[d,c]=(0,r.useState)(0),[o,x]=(0,r.useState)(0),[m,u]=(0,r.useState)(1);(0,r.useEffect)(()=>{let e=n.current;if(!e)return;let s=()=>c(e.currentTime),t=()=>x(e.duration),a=()=>l(!1);return e.addEventListener("timeupdate",s),e.addEventListener("loadedmetadata",t),e.addEventListener("ended",a),()=>{e.removeEventListener("timeupdate",s),e.removeEventListener("loadedmetadata",t),e.removeEventListener("ended",a)}},[s]);let h=(0,r.useCallback)(()=>{let e=n.current;e&&(i?e.pause():e.play(),l(!i))},[i]),p=e=>{let s=n.current;s&&(s.currentTime=e)},g=e=>{let s=n.current;s&&(s.currentTime=Math.max(0,Math.min(o,s.currentTime+e)))};return(0,r.useEffect)(()=>{t&&(window.audioSeekTo=e=>{p(e/1e3),i||h()})},[t,i,h]),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("audio",{ref:n,src:s}),(0,a.jsx)("div",{className:"w-full h-2 bg-gray-200 rounded-full cursor-pointer relative",onClick:e=>{let s=e.currentTarget.getBoundingClientRect();p((e.clientX-s.left)/s.width*o)},children:(0,a.jsx)("div",{className:"h-full bg-blue-500 rounded-full transition-all duration-100",style:{width:"".concat(o?d/o*100:0,"%")}})}),(0,a.jsxs)("div",{className:"flex justify-between text-sm text-gray-500",children:[(0,a.jsx)("span",{children:f(1e3*d)}),(0,a.jsx)("span",{children:f(1e3*o)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,a.jsxs)(v,{variant:"outline",size:"sm",onClick:()=>g(-10),className:"flex items-center gap-1",children:[(0,a.jsx)(X.Z,{className:"h-4 w-4"}),"-10s"]}),(0,a.jsx)(v,{onClick:h,className:"flex items-center gap-2 px-6",children:i?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(H.Z,{className:"h-4 w-4"}),"暂停"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(K.Z,{className:"h-4 w-4"}),"播放"]})}),(0,a.jsxs)(v,{variant:"outline",size:"sm",onClick:()=>g(10),className:"flex items-center gap-1",children:["+10s",(0,a.jsx)(J.Z,{className:"h-4 w-4"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(Q.Z,{className:"h-4 w-4 text-gray-500"}),(0,a.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:m,onChange:e=>{let s=parseFloat(e.target.value);u(s),n.current&&(n.current.volume=s)},className:"flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"})]})]})}function ee(e){let{transcription:s,annotations:t,onAnnotationClick:r}=e;return(0,a.jsxs)(y,{children:[(0,a.jsxs)(_,{children:[(0,a.jsx)(w,{className:"text-lg",children:"完整转写文本"}),(0,a.jsx)(k,{children:"点击高亮部分可跳转至音频对应位置。颜色表示不同的问题类型。"})]}),(0,a.jsxs)(C,{children:[(0,a.jsx)("div",{className:"p-4 bg-gray-50 rounded-lg",children:(0,a.jsx)("p",{className:"text-base leading-relaxed whitespace-pre-wrap",children:(()=>{let e=[];t.forEach((t,a)=>{let r=s.indexOf(t.detected_text);-1!==r&&e.push({text:t.detected_text,annotation:t,index:r})}),e.sort((e,s)=>e.index-s.index);let n=[],i=0;return e.forEach((e,t)=>{e.index>i&&n.push((0,a.jsx)("span",{children:s.slice(i,e.index)},"text-".concat(t))),n.push((0,a.jsx)("mark",{className:p("cursor-pointer transition-colors hover:opacity-80 rounded px-1",j(e.annotation.issue_type),N(e.annotation.issue_type)&&"font-semibold"),onClick:()=>r(e.annotation),title:"".concat(g(e.annotation.issue_type),": ").concat(e.annotation.explanation),children:e.text},"highlight-".concat(t))),i=e.index+e.text.length}),i<s.length&&n.push((0,a.jsx)("span",{children:s.slice(i)},"text-end")),n})()})}),(0,a.jsxs)("div",{className:"mt-4 p-3 bg-blue-50 rounded border border-blue-200",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-blue-800 mb-2",children:"问题类型说明:"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-red-200 rounded"}),(0,a.jsx)("span",{children:"发音/意思错误"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-yellow-200 rounded"}),(0,a.jsx)("span",{children:"回答不完整"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-orange-200 rounded"}),(0,a.jsx)("span",{children:"口齿不清"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-green-200 rounded"}),(0,a.jsx)("span",{children:"自我纠正"})]})]})]})]})]})}function es(e){let{annotations:s,onAnnotationClick:t}=e;if(0===s.length)return(0,a.jsxs)(y,{children:[(0,a.jsxs)(_,{children:[(0,a.jsx)(w,{className:"text-lg",children:"问题总结"}),(0,a.jsx)(k,{children:"AI识别出的待复核问题点"})]}),(0,a.jsx)(C,{children:(0,a.jsxs)("div",{className:"text-center py-8",children:[(0,a.jsx)("div",{className:"text-green-500 text-2xl mb-2",children:"\uD83C\uDF89"}),(0,a.jsx)("p",{className:"text-gray-600",children:"未检测到错误，表现优秀！"})]})})]});let r=s.filter(e=>N(e.issue_type)),n=s.filter(e=>!N(e.issue_type));return(0,a.jsxs)(y,{children:[(0,a.jsxs)(_,{children:[(0,a.jsxs)(w,{className:"text-lg",children:["问题总结 (",s.length,"个问题点)"]}),(0,a.jsx)(k,{children:"AI识别出的待复核问题点。点击可跳转到音频对应位置。"})]}),(0,a.jsxs)(C,{className:"space-y-4",children:[r.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"font-medium text-red-700 mb-2",children:["严重问题 (",r.length,"个)"]}),(0,a.jsx)("div",{className:"space-y-2",children:r.map((e,s)=>(0,a.jsxs)("div",{onClick:()=>t(e),className:"p-3 border border-red-200 rounded-lg cursor-pointer hover:bg-red-50 transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:p("px-2 py-1 text-xs font-medium rounded border",j(e.issue_type)),children:g(e.issue_type)}),(0,a.jsxs)("span",{className:"font-medium",children:['题目: "',e.question,'"']})]}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:f(e.start_time)})]}),(0,a.jsx)("p",{className:"text-sm text-gray-700 mb-1",children:e.explanation}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,a.jsx)("span",{className:"font-medium",children:"学生回答:"}),' "',e.detected_text,'" |',(0,a.jsx)("span",{className:"font-medium ml-1",children:"标准答案:"}),' "',e.expected_answer,'"']})]},"hard-".concat(s)))})]}),n.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"font-medium text-orange-700 mb-2",children:["观察点 (",n.length,"个)"]}),(0,a.jsx)("div",{className:"space-y-2",children:n.map((e,s)=>(0,a.jsxs)("div",{onClick:()=>t(e),className:"p-3 border border-orange-200 rounded-lg cursor-pointer hover:bg-orange-50 transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:p("px-2 py-1 text-xs font-medium rounded border",j(e.issue_type)),children:g(e.issue_type)}),(0,a.jsxs)("span",{className:"font-medium",children:['题目: "',e.question,'"']})]}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:f(e.start_time)})]}),(0,a.jsx)("p",{className:"text-sm text-gray-700 mb-1",children:e.explanation}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,a.jsx)("span",{className:"font-medium",children:"学生回答:"}),' "',e.detected_text,'" |',(0,a.jsx)("span",{className:"font-medium ml-1",children:"标准答案:"}),' "',e.expected_answer,'"']})]},"soft-".concat(s)))})]})]})]})}function et(e){let{taskId:s,initialGrade:t,initialComment:n}=e,[i,l]=(0,r.useState)(t),[d,c]=(0,r.useState)(n),[o,x]=(0,r.useState)(!1),m=function(){let e=(0,I.NL)(),{setError:s}=R();return(0,S.D)({mutationFn:e=>D.submitTeacherFeedback(e),onSuccess:(s,t)=>{e.invalidateQueries({queryKey:Z.task(t.task_id)}),e.invalidateQueries({queryKey:Z.report(t.task_id)})},onError:e=>{s("提交反馈失败: ".concat(e.message))}})}();return(0,a.jsxs)(y,{children:[(0,a.jsx)(_,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(w,{className:"text-lg",children:"教师综合评语"}),(0,a.jsx)(k,{children:"复核AI建议，并给出最终评定"})]}),(0,a.jsxs)(v,{variant:"outline",size:"sm",onClick:()=>x(!o),className:"flex items-center gap-2",children:[(0,a.jsx)(V.Z,{className:"h-4 w-4"}),o?"取消编辑":"编辑"]})]})}),(0,a.jsx)(C,{children:(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),m.mutate({task_id:s,final_grade:i,teacher_comment:d,approved_at:new Date().toISOString()},{onSuccess:()=>{x(!1),alert("反馈提交成功！")}})},className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"最终评级"}),(0,a.jsx)("div",{className:"flex gap-2",children:["A","B","C"].map(e=>(0,a.jsxs)("button",{type:"button",disabled:!o,onClick:()=>l(e),className:p("px-4 py-2 rounded border font-medium transition-colors",i===e?"bg-blue-500 text-white border-blue-500":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50",!o&&"opacity-60"),children:[e,"级"]},e))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"teacher-comment",className:"block text-sm font-medium text-gray-700 mb-2",children:"评语"}),(0,a.jsx)("textarea",{id:"teacher-comment",value:d,onChange:e=>c(e.target.value),disabled:!o,rows:4,className:p("w-full p-3 border border-gray-300 rounded-lg resize-none",o?"bg-white":"bg-gray-50",!o&&"cursor-default"),placeholder:"请输入您的评语..."})]}),o&&(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(v,{type:"submit",disabled:m.isPending,className:"flex items-center gap-2",children:[(0,a.jsx)(Y.Z,{className:"h-4 w-4"}),m.isPending?"提交中...":"确认并保存"]}),(0,a.jsx)(v,{type:"button",variant:"outline",onClick:()=>{l(t),c(n),x(!1)},children:"重置"})]})]})})]})}function ea(e){let{taskId:s}=e,{data:t,isLoading:r,error:n}=function(e){let{setSelectedReport:s}=R();return(0,O.a)({queryKey:Z.report(e),queryFn:async()=>{if(!e)return null;let t=await D.getReportDetail(e);return s(t),t},enabled:!!e,staleTime:6e4})}(s),i=e=>{window.audioSeekTo&&window.audioSeekTo(e.start_time)};return r?(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsx)(q,{})}):n?(0,a.jsx)(y,{children:(0,a.jsx)(C,{className:"p-6 text-center",children:(0,a.jsxs)("p",{className:"text-red-600",children:["加载报告失败: ",n.message]})})}):t?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(y,{children:(0,a.jsx)(_,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)(w,{className:"text-xl",children:[t.student_name," - 评测报告"]}),(0,a.jsxs)(k,{children:["单元: ",t.unit_id," | 会话: ",t.session_index]})]}),(0,a.jsxs)("div",{className:p("px-3 py-1 rounded text-sm font-medium border","grade-".concat(t.final_grade_suggestion)),children:[t.final_grade_suggestion," 级"]})]})})}),(0,a.jsxs)(y,{children:[(0,a.jsxs)(_,{children:[(0,a.jsx)(w,{className:"text-lg",children:"学生录音"}),(0,a.jsx)(k,{children:"使用播放控件收听录音，或点击问题点直接跳转"})]}),(0,a.jsx)(C,{children:(0,a.jsx)($,{audioUrl:t.audio_url})})]}),(0,a.jsx)(ee,{transcription:t.full_transcription,annotations:t.annotations,onAnnotationClick:i}),(0,a.jsx)(es,{annotations:t.annotations,onAnnotationClick:i}),(0,a.jsx)(et,{taskId:s,initialGrade:t.final_grade_suggestion,initialComment:t.ai_summary_comment})]}):(0,a.jsx)(y,{children:(0,a.jsx)(C,{className:"p-6 text-center",children:(0,a.jsx)("p",{className:"text-gray-500",children:"未找到报告数据"})})})}class er extends r.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("ErrorBoundary caught an error:",e,s)}render(){if(this.state.hasError){var e;let s=this.props.fallback;return s&&this.state.error?(0,a.jsx)(s,{error:this.state.error,reset:this.reset}):(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-8 text-center",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-red-600 mb-2",children:"出现错误"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:(null===(e=this.state.error)||void 0===e?void 0:e.message)||"发生未知错误"}),(0,a.jsx)("button",{onClick:this.reset,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"重试"})]})}return this.props.children}constructor(e){super(e),this.reset=()=>{this.setState({hasError:!1,error:void 0})},this.state={hasError:!1}}}function en(){let{selectedTaskId:e}=R(),{isLoading:s,error:t}=F();return t?(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,a.jsx)(M,{}),(0,a.jsx)("main",{className:"container mx-auto px-4 py-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"加载失败"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:t.message}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"重新加载"})]})})]}):(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,a.jsx)(M,{}),(0,a.jsx)("main",{className:"container mx-auto px-4 py-8",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,a.jsx)("div",{className:"lg:col-span-1",children:(0,a.jsx)(er,{children:(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)(q,{}),children:s?(0,a.jsx)(q,{}):(0,a.jsx)(z,{})})})}),(0,a.jsx)("div",{className:"lg:col-span-2",children:(0,a.jsx)(er,{children:(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)(q,{}),children:e?(0,a.jsx)(ea,{taskId:e}):(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-8 text-center",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-500 mb-2",children:"请选择学生查看评测报告"}),(0,a.jsx)("p",{className:"text-gray-400",children:"从左侧列表中点击学生卡片来查看详细的评测报告和音频分析"})]})})})})]})})]})}}},function(e){e.O(0,[735,8,971,938,744],function(){return e(e.s=6583)}),_N_E=e.O()}]);